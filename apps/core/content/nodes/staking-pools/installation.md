---
head:
  - - meta
    - property: og:title
      content: Staking Pools Installation Guide
  - - meta
    - name: description
      content: How to install and deploy staking pools using the factory contract
  - - meta
    - property: og:description
      content: How to install and deploy staking pools using the factory contract
---

<script setup>
  import config from '@berachain/config/constants.json';
</script>

# Staking Pools Installation Guide

This guide provides step-by-step instructions for deploying staking pools using the `StakingPoolContractsFactory`. The factory contract handles the deployment of all necessary contracts and ensures they are properly configured for your validator.

## Prerequisites

Before proceeding with the installation, ensure you have:

- **Validator Setup**: A fully operational Berachain validator node
- **Validator Keys**: Your validator's public key and withdrawal credentials
- **Initial Stake**: At least {{ config.mainnet.minEffectiveBalance.toLocaleString() }} BERA for the initial deposit
- **Web3 Environment**: Access to a web3 provider (MetaMask, WalletConnect, or programmatic access)
- **Gas Fees**: Sufficient BERA for deployment and initialization transactions

:::warning
Staking pools are only available for new validators. Existing validators must perform a full withdrawal and recreate their validator to use staking pools.
:::

## System Architecture Overview

The staking pools system uses a factory pattern where the `StakingPoolContractsFactory` deploys and manages all related contracts:

- **StakingPoolContractsFactory**: Main factory contract that orchestrates deployment
- **StakingPool**: Core contract for user deposits and share management
- **SmartOperator**: Manages validator operations and PoL integration
- **WithdrawalVault**: Handles withdrawal requests and processing
- **StakingRewardsVault**: Manages rewards and auto-compounding
- **IncentiveCollector**: Handles incentive token collection and conversion
- **AccountingOracle**: Provides off-chain data validation

## Step 1: Prepare Validator Data

### Generate Validator Keys

First, you need to generate your validator keys using the beacon client:

```bash
# Generate validator keys
beacond deposit validator-keys --home $BEACOND_HOME

# This will output your validator's public key in 48-byte hex format
# Example: 0x9308360bb1e8c237c2a4b6734782426e6e42bc7a43008ba5e3d9f3c70143227ea1fb2a08b21cbbedf87cebf27e81669d
```

### Prepare Withdrawal Credentials

Your withdrawal credentials must match what the smart contract expects based on its own withdrawal vault address. To generate the correct credentials:

1. **Calculate the predicted addresses** using the factory's `predictStakingPoolContractsAddresses` function
2. **Generate the withdrawal credentials** using the predicted withdrawal vault address
3. **Create the deposit signature** with the correct withdrawal credentials

:::tip
The smart contract validates that your withdrawal credentials match what it expects based on its own withdrawal vault address. You need to calculate this in advance to generate the proper deposit signature.
:::

## Step 2: Deploy Staking Pool Contracts

### Using the Factory Contract

The `StakingPoolContractsFactory.deployStakingPoolContracts()` function handles the deployment of all necessary contracts in a single transaction:

```solidity
function deployStakingPoolContracts(
    bytes memory pubkey,           // Your 48-byte validator public key
    bytes memory withdrawalCredentials, // Withdrawal credentials (0x01 + withdrawal vault address)
    bytes memory signature,         // Deposit signature from beacon client
    address validatorAdmin,         // Address with admin privileges over your pool
    address defaultSharesRecipient  // Address to receive initial shares (usually your validator wallet)
)
    external
    payable
    returns (address, address, address, address);
```

### Deployment Parameters

- **`pubkey`**: Your validator's 48-byte public key in hex format
- **`withdrawalCredentials`**: Must be `0x01` followed by the 20-byte withdrawal vault address (the smart contract validates this matches its expected value)
- **`signature`**: The deposit signature generated by your beacon client
- **`validatorAdmin`**: Address that will have administrative control over your pool (recommend using a multisig for security)
- **`defaultSharesRecipient`**: Address that receives the initial shares in the pool (typically your validator wallet)

### Required Value

The deployment transaction must include exactly {{ config.mainnet.minEffectiveBalance.toLocaleString() }} BERA (10,000 BERA) as the initial deposit. This stake serves as the foundation for your staking pool.

### Example Deployment Transaction

```javascript
// Using ethers.js
const factory = new ethers.Contract(factoryAddress, factoryABI, signer);

const tx = await factory.deployStakingPoolContracts(
  validatorPubkey, // 48-byte hex string
  withdrawalCredentials, // 0x01 + 20-byte address
  depositSignature, // From beacon client
  validatorAdminAddress, // Your admin address
  defaultSharesRecipient, // Your validator wallet
  { value: ethers.parseEther("10000") }, // 10,000 BERA
);

const receipt = await tx.wait();
```

## Step 3: Verify Contract Deployment

### Check Deployed Addresses

After successful deployment, verify that the predicted addresses match the actual deployed addresses:

```solidity
function predictStakingPoolContractsAddresses(
    bytes memory pubkey
) external view returns (CoreContracts memory);
```

### Verify Contract State

Check that all contracts are properly initialized:

```solidity
// Get deployed contracts for your validator
function getCoreContracts(
    bytes memory pubkey
) external view returns (CoreContracts memory);
```

The returned `CoreContracts` struct contains:

- `smartOperator`: Address of your SmartOperator contract
- `stakingPool`: Address of your StakingPool contract
- `stakingRewardsVault`: Address of your StakingRewardsVault contract
- `incentiveCollector`: Address of your IncentiveCollector contract

## Step 4: Initialize the Pool

### Register Validator with Pool Contracts

Once your contracts are deployed, you need to register your validator with the pool contracts using the `BeaconDeposit` contract:

```solidity
function deposit(
    bytes memory pubkey,
    bytes memory withdrawal_credentials,
    bytes memory signature,
    bytes32 deposit_data_root
) external payable;
```

**Critical Configuration:**

- **Withdrawal Credentials**: Must match your deployed `WithdrawalVault` address
- **Operator Address**: Must be set to your `SmartOperator` contract address
- **Initial Deposit**: Must be exactly {{ config.mainnet.minEffectiveBalance.toLocaleString() }} BERA

### Obtain Verification Proofs

After registration, you'll need to obtain proofs from the beacon API:

```bash
# Get validator index proof
curl "https://beacon-api.berachain.com/eth/v1/beacon/proof/validators/{validator_index}"

# Get withdrawal credentials proof
curl "https://beacon-api.berachain.com/eth/v1/beacon/proof/withdrawal_credentials/{validator_index}"

# Get initial balance proof
curl "https://beacon-api.berachain.com/eth/v1/beacon/proof/validators/{validator_index}/balance"
```

:::warning
The beacon API endpoints above are examples and may not be available on Berachain. You should verify the correct API endpoints for your specific network configuration.
:::

### Activate the Pool

Use the factory contract to activate your staking pool:

```solidity
function activateStakingPool(
    ValidatorData calldata validatorData,
    ProofData calldata proofData,
    uint64 timestamp
) external;
```

The `ValidatorData` struct includes:

- `pubkey`: Your validator's public key
- `withdrawalCredentials`: Your withdrawal credentials
- `operator`: Your SmartOperator contract address
- `initialBalance`: Your initial deposit amount

The `ProofData` struct includes:

- `indexProof`: Proof of your validator index
- `withdrawalCredentialsProof`: Proof of your withdrawal credentials
- `initialBalanceProof`: Proof of your initial balance

## Step 5: Configure Pool Operations

### Set Commission Rates

Configure your validator commission rate (maximum 10%):

```solidity
function setValidatorCommissionRate(uint256 commissionRate) external;
```

### Configure Reward Allocation

Set how Proof of Liquidity rewards are allocated:

```solidity
function setRewardAllocation(
    address[] memory rewardVaults,
    uint256[] memory weights
) external;
```

### Initialize BGT Operations

Set up BGT boost management for your validator:

```solidity
function queueBoost(uint256 amount) external;
function activateBoost() external;
```

## Deployment Verification Checklist

After completing the deployment, verify:

- [ ] All contracts deployed to predicted addresses
- [ ] Validator registered with correct withdrawal credentials
- [ ] Pool activated with valid proofs
- [ ] Commission rates configured
- [ ] Reward allocation set
- [ ] BGT operations initialized
- [ ] Pool accepting deposits (if desired)

## Troubleshooting Common Issues

### Deployment Failures

**Insufficient Value**

- Ensure transaction includes exactly {{ config.mainnet.minEffectiveBalance.toLocaleString() }} BERA
- Check that your wallet has sufficient balance

**Invalid Withdrawal Credentials**

- Verify withdrawal credentials format (0x01 + 20-byte address)
- Ensure address matches predicted withdrawal vault address

**Signature Verification Failed**

- Verify deposit signature is from correct validator keys
- Check that withdrawal credentials in signature match deployment parameters

### Activation Issues

**Proof Verification Failed**

- Ensure proofs are recent (within 10 minutes)
- Verify proofs are from correct validator index
- Check that withdrawal credentials proofs match deployed contracts

**Pool Not Activating**

- Verify all required proofs are provided
- Check that validator data matches deployed contracts
- Ensure timestamp is within acceptable range

## Security Considerations

### Access Control

- **Admin Role**: Use a multisig wallet for admin privileges
- **Validator Operations**: Keep validator keys secure and separate from admin keys
- **Emergency Controls**: Understand pause and emergency exit mechanisms

### Contract Verification

- **Address Verification**: Always verify contract addresses before interactions
- **Proof Validation**: Ensure all proofs are recent and valid
- **Oracle Dependencies**: Monitor oracle updates for accuracy

## Next Steps

After successful deployment and activation:

1. **Test Operations**: Verify deposits, withdrawals, and reward distribution
2. **Monitor Performance**: Track pool performance and user activity
3. **Optimize Settings**: Fine-tune commission rates and reward allocation
4. **Community Building**: Attract users to your staking pool

## Support and Resources

- **Technical Documentation**: [Smart Contract Reference](/nodes/staking-pools/contracts)
- **Validator Community**: Join Berachain validator channels
- **Technical Support**: Contact Berachain technical support for deployment issues

:::tip
Successful staking pool deployment requires careful attention to detail. Double-check all parameters and proofs before submitting transactions.
:::

:::warning
The off-chain oracle and incentive management bot components are required for full functionality but are not yet implemented. These will be deployed separately and integrated with the staking pools system.
:::
